<!DOCTYPE HTML>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="MyFuelCSS\style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="icon" href="icon.png">

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- for FF, Chrome, Opera -->
    <link rel="icon" type="image/png" href="icon.png" sizes="16x16">
    <link rel="icon" type="image/png" href="icon.png" sizes="32x32">

    <!-- for IE -->
    <link rel="icon" type="image/x-icon" href="icon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="icon.ico" />

    <!-- for Safari -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="icon.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="icon.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="icon.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="icon.png" />

    <title>MyFuelApp</title>
	


</head>
<body onload="init()">

	
<?php

// inizializzazione della sessione
session_start();
// controllo sul valore di sessione
if (!isset($_SESSION['login']))
{
 // reindirizzamento alla homepage in caso di login mancato
 header("Location: MyFuelLogin.php");
}
?>



    <div class="InputForm">
        <h1 align="center"> MyFuel </h1>
        <h4 align="center">Ver.: 1.0 </h4>
        <h6 align="center"> 20170323 </h6>
        <h2>Dati di Rifornimento</h2>
        <label for=Date>Data:</label>
        <input type="date" name="Date" id="Date" size=10>

        <br><br>
        <label>Km Precedenti: </label><label id="KmPrecedenti" for="KmPrecedenti" class="Labelvalue">0</label>
        <br><br>

        <label for=KmTot>Km:</label>
        <input type="tel" name="KmTot" placeholder="0" id="KmTot" onblur="CalcValue()" class="dark-input" size=8 autofocus>

        <font size="2"><label>Km Parz.: </label><label id="KmPercorsi" for="KmPercorsi" class="Labelvalue">-</label></font>
        <br><br>

        <label for=euroLitro>€/litro:</label>
        <input type="number" step="0.001" min="0" max="2" name="euroLitro" placeholder="1,..." id="euroLitro" onblur="CalcValue()" class="dark-input">
        <br><br>

        <label for=Euro>Euro:</label>
        <input type="number" step="0.01" min="1" max="200" name="Euro" placeholder="0" id="Euro" onblur="CalcValue()" class="dark-input">
        <br><br>

        <!--            Calcolati         -->

        <label>Litri: </label><label id="Litri" for="Litri" class="Labelvalue">0</label>
        <br><br>

        <font size="2">
            <label>l\100Km: </label><label id="Litri100Km" for="Litri100Km" class="Labelvalue">0</label>
            <!--<br><br>-->
            <label>€\Km: </label><label id="EuroKm" for="EuroKm" class="Labelvalue">0</label>
        </font>

        <br><br>
        <input type="button" id="check" name="check" value="Salva" Onclick="Send()" disabled style="font-size : 15px; width: 50%; ">
        
        <hr>
        <input type="button" id="Home" name="Home" value="Home" Onclick="window.location.href='MyFuelIndex.php'" style="font-size : 15px; width: 50%; ">
        <p id="error"></p>
    </div>

    <script>


/*
Inizializza i dati nella maschera
TODO: Aggiungere il recupero dell'ultimo kilometraggio
*/
function init(){

try{
	var KmPrecedente = "0";
	var KmTot = "";
	var KmPercorsi ="";
	var euroLitro = "1.339";
	var Euro = "";
	var Litri = "0";
	var Litri100Km = "0";
	var EuroKm = "0";

document.getElementById("check").disabled = true;
	document.getElementById("error").innerHTML = "";

	//Imposta il giorno di oggi
	var date = new Date();
	var currentDate = date.toISOString().slice(0,10);
	document.getElementById("Date").value = currentDate;
	
	

	//Recupera i Km Precedenti
	GetDataKmPrecedenti()

	 document.getElementById("KmTot").value = KmTot;
	 document.getElementById("KmPercorsi").innerHTML = KmPercorsi;

	 document.getElementById("Litri").innerHTML = Litri;

	document.getElementById("Euro").value = Euro ;
	 document.getElementById("EuroKm").innerHTML = EuroKm;
	 document.getElementById("euroLitro").value = euroLitro;
	document.getElementById("Litri100Km").innerHTML = Litri100Km;

}catch(err){
	document.getElementById("error").innerHTML = err.message;
}
}

//Recupera i Km Precedenti
function GetDataKmPrecedenti(){

	try{

		$.get("GetLastMF.php").done(function(data){
	  console.log(data);

	var jsonobj = JSON.parse(data);
	document.getElementById("KmPrecedenti").innerHTML = String(jsonobj[0].KM);
});

	}catch(err){
		document.getElementById("error").innerHTML = err.message;
	}
}


/*
Calcola i valori
*/
function CalcValue() {

	try{

	var mKmTot = document.getElementById("KmTot");
	var mKmPrecedenti = document.getElementById("KmPrecedenti");

	var mEuro = document.getElementById("Euro");
	var mEuroLitro = document.getElementById("euroLitro");
	
	if (mKmTot.value != "") {

	//Calcola i Km Percorsi
	document.getElementById("KmPercorsi").innerHTML  = (Number(mKmTot.value) - Number(mKmPrecedenti.innerHTML));

	//Calcola i litri
	document.getElementById("Litri").innerHTML = Math.round((Number(mEuro.value) / Number(mEuroLitro.value))* 100) / 100;

	var mLitri = document.getElementById("Litri");
	var mKmPercorsi = document.getElementById("KmPercorsi");

	//Calcola i litri per 100Km
	var l100 = (Number(mLitri.innerHTML) *100) / Number(mKmPercorsi.innerHTML)
	document.getElementById("Litri100Km").innerHTML =  Math.round( l100 * 100) / 100;

	//Calcola Euro al Km
	var EuroKm = (Number(mEuro.value) / Number(mKmPercorsi.innerHTML))
	document.getElementById("EuroKm").innerHTML =  Math.round( EuroKm * 1000) / 1000;

	//Verifica che i valori siano inseriti correttamente
	CheckValue();
	
	}
	
	return true;

	}catch(err){
    document.getElementById("error").innerHTML = err.message;
	}
}
/*
Verifica se i valori sono corretti

*/
function CheckValue() {

	try {
	
	//Verifica che sia compilato il valore euro
	if (document.getElementById("Euro").value == "") {
		document.getElementById("check").disabled = true;
		return false;
	}else{
		document.getElementById("check").disabled = false;
		return true;
		}
	
	
		//Verifica i Km inseriti
		if (document.getElementById("KmPercorsi").innerHTML.indexOf("-") != -1)  { 
	
			document.getElementById("KmTot").style.color = "red";
			document.getElementById("check").disabled = true;
			return false;
		}else{
			document.getElementById("KmTot").style.color = "black";
				document.getElementById("check").disabled = false;
			return true;
		}
		
	
		
	}catch(err){
		document.getElementById("error").innerHTML = err.message;
	}
}

function Send(){

	try{

	var mData = document.getElementById("Date");
	var mKmTot = document.getElementById("KmTot");
	var mLitri = document.getElementById("Litri");
	var mKmPercorsi = document.getElementById("KmPercorsi");
	var mEuro = document.getElementById("Euro");
	var mEuroKm = document.getElementById("EuroKm");
	var mEuroLitro = document.getElementById("euroLitro");
	var ml100km = document.getElementById("Litri100Km");
	var mParziale = 0

    $.ajax({
        url: '../InsertMF.php',
        type: 'POST',
        data: {DATE:mData.value,KMTOT:mKmTot.value,LITRI: mLitri.innerHTML,KM: mKmPercorsi.innerHTML,EURO:mEuro.value,EURO_KM:mEuroKm.innerHTML,EURO_LITRO:mEuroLitro.value,LITRI_100KM:ml100km.innerHTML,PARZIALE:0},
		success: function(data) {
			window.alert("Dati inseriti con successo");
            console.log("success"); // Inspect this in your console
			document.getElementById("error").innerHTML = "Dati inseriti con successo"
init();
        }
    });


}catch(err){
	console.log(err.message);
		document.getElementById("error").innerHTML = err.message;
	}
}

    </script>
</body>
</html>